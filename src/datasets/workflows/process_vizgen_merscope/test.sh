#!/bin/bash

# get the root of the directory
REPO_ROOT=$(git rev-parse --show-toplevel)

# ensure that the command below is run from the root of the repository
cd "$REPO_ROOT"

set -e

# Create local output directory
output_dir="resources/datasets"

if [ ! -d "$output_dir" ]; then
  mkdir -p "$output_dir"
fi

# Define which datasets to process (uncomment to include)
DATASETS_TO_PROCESS=(
    "vizgen_merscope/2022_vizgen_human_breast_cancer_merfish/rep1"
    # "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep1"
    # "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep2"
    # "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep1"
    # "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep2"
)

# Create params.yaml with only selected datasets
cat > /tmp/params.yaml << 'HERE'
param_list:
HERE

#cat > /tmp/params.yaml << HERE
#param_list:
#
#  - id: "vizgen_merscope/2022_vizgen_human_breast_cancer_merfish/rep1"
#    gcloud_bucket: "vz-ffpe-showcase"
#    dataset_bucket_name: "HumanBreastCancerPatient1"
#    dataset_name: "Vizgen Human Breast Cancer MERFISH Patient1"
#    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
#    dataset_summary: "Human Breast Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
#    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
#    dataset_organism: "homo_sapiens"
#    segmentation_id: ["cell"]
#
#output_dataset: "\$id/dataset.zarr"
#output_state: "\$id/state.yaml"
#publish_dir: "$output_dir"
#HERE

##bash case syntax:
##case $variable in
##    pattern1)
##        # commands for pattern1
##        ;;
##    pattern2)
##        # commands for pattern2
##        ;;
##esac
#
# Add only the selected datasets to params.yaml
for dataset in "${DATASETS_TO_PROCESS[@]}"; do
    case $dataset in
        "vizgen_merscope/2022_vizgen_human_breast_cancer_merfish/rep1")
            cat >> /tmp/params.yaml << 'HERE'

  - id: "vizgen_merscope/2022_vizgen_human_breast_cancer_merfish/rep1"
    dataset_id: "vizgen_merscope/2022_vizgen_human_breast_cancer_merfish/rep1"
    input: "gs://vz-ffpe-showcase/HumanBreastCancerPatient1"
    dataset_name: "Vizgen Human Breast Cancer MERFISH Patient1"
    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
    dataset_summary: "Human Breast Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
    dataset_organism: "homo_sapiens"
    segmentation_id: ["cell"]
HERE
            ;;
        "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep1")
            cat >> /tmp/params.yaml << 'HERE'

  - id: "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep1"
    dataset_id: "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep1"
    input: "gs://vz-ffpe-showcase/HumanLiverCancerPatient1"
    dataset_name: "Vizgen Human Liver Cancer MERFISH Patient1"
    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
    dataset_summary: "Human Liver Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
    dataset_organism: "homo_sapiens"
    segmentation_id: ["cell"]
HERE
            ;;
        "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep2")
            cat >> /tmp/params.yaml << 'HERE'

  - id: "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep2"
    dataset_id: "vizgen_merscope/2022_vizgen_human_liver_cancer_merfish/rep2"
    input: "gs://vz-ffpe-showcase/HumanLiverCancerPatient2"
    dataset_name: "Vizgen Human Liver Cancer MERFISH Patient2"
    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
    dataset_summary: "Human Liver Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
    dataset_organism: "homo_sapiens"
    segmentation_id: ["cell"]
HERE
            ;;
        "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep1")
            cat >> /tmp/params.yaml << 'HERE'

  - id: "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep1"
    dataset_id: "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep1"
    input: "gs://vz-ffpe-showcase/HumanLungCancerPatient1"
    dataset_name: "Vizgen Human Lung Cancer MERFISH Patient1"
    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
    dataset_summary: "Human Lung Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
    dataset_organism: "homo_sapiens"
    segmentation_id: ["cell"]
HERE
            ;;
        "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep2")
            cat >> /tmp/params.yaml << 'HERE'

  - id: "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep2"
    dataset_id: "vizgen_merscope/2022_vizgen_human_lung_cancer_merfish/rep2"
    input: "gs://vz-ffpe-showcase/HumanLungCancerPatient2"
    dataset_name: "Vizgen Human Lung Cancer MERFISH Patient2"
    dataset_url: "https://info.vizgen.com/ffpe-showcase?submissionGuid=a93dbab5-c128-4269-afe3-82ea2bf9cdaf"
    dataset_summary: "Human Lung Cancer data from the MERSCOPE FFPE Human Immuno-Oncology Data Release."
    dataset_description: "The MERSCOPE FFPE Human Immuno-Oncology Data Release was generated using the MERSCOPE FFPE Sample Prep Solution and the MERSCOPE Immuno-Oncology Predesigned Panel. This data release includes 16 MERFISH datasets generated by the MERSCOPE Platform from 8 different human tumor types, each measuring 500 genes representing approximately 4 billion transcripts and 9 million cells cumulatively."
    dataset_organism: "homo_sapiens"
    segmentation_id: ["cell"]
HERE
            ;;
    esac
done

cat >> /tmp/params.yaml << HERE

output_dataset: "\$id/dataset.zarr"
output_state: "\$id/state.yaml"
publish_dir: "$output_dir"
HERE

# Run nextflow workflow locally
nextflow run . \
  -main-script target/nextflow/datasets/workflows/process_vizgen_merscope/main.nf \
  -params-file /tmp/params.yaml \
  -profile docker \
  -c common/nextflow_helpers/labels_ci.config