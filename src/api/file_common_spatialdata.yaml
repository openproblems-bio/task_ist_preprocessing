#SpatialData object, with associated Zarr store: </paht/to/data.zarr>
#├── Images
#│     ├── '{rep}_he_image': DataTree[cyx] (3, 45087, 11580), (3, 22543, 5790), (3, 11271, 2895), (3, 5635, 1447), (3, 2817, 723)
#│     ├── '{rep}_{flourescence_img}': DataTree[cyx] (2, 17098, 51187), (2, 8549, 25593), (2, 4274, 12796), (2, 2137, 6398), (2, 1068, 3199)
#│     └── '{rep}_{flourescence_img}_3D': DataTree[czyx] (2, 8, 17098, 51187), (2, 8, 8549, 25593), (2, 8, 4274, 12796), (2, 8, 2137, 6398), (2, 8, 1068, 3199)
#├── Labels
#│     ├── '{rep}_{segm1}': DataTree[yxz] (17098, 51187, 3), (8549, 25593, 3), (4274, 12796, 3), (2137, 6398, 3), (1068, 3199, 3)
#│     ├── '{rep}_{segm2}': DataTree[yxz] (17098, 51187, 3), (8549, 25593, 3), (4274, 12796, 3), (2137, 6398, 3), (1068, 3199, 3)
#│     └── '{rep}_expert_segm_{patch}': DataTree[yxz] (17098, 51187, 3), (8549, 25593, 3), (4274, 12796, 3), (2137, 6398, 3), (1068, 3199, 3)
#├── Points
#│     └── '{rep}_transcripts': DataFrame with shape: (<Delayed>, 11) (3D points)
#├── Shapes
#│     ├── '{rep}_{segm1}_boundaries': GeoDataFrame shape: (162254, 1) (2D shapes - 3D supported??)
#│     └── '{rep}_{segm2}_boundaries': GeoDataFrame shape: (162254, 1) (2D shapes)
#└── Tables
#      ├── '{rep}_{segm1}': AnnData (162254, 377)
#      ├── '{rep}_{segm2}': AnnData (162254, 377)
#      ├── '{reference1}': AnnData (n_obs_ref1, ?) 
#      └── '{reference2}': AnnData (n_obs_ref2, ?)
#with coordinate systems:
#    ▸ '{rep}_global', with elements:
#        ....

type: file
example: "resources_test/common/2023_10x_mouse_brain_xenium/dataset.zarr"
label: "Common iST Dataset"
summary: An unprocessed spatial imaging dataset stored as a zarr file.
description: |
  This dataset contains raw images, labels, points, shapes, and tables as output by a dataset loader.
info:
  format:
    type: spatialdata_zarr
    variables:
      - name: replicate_id
        type: string
        description: The replicate identifier
        required: true
      # - name: reference_id
      #   type: str
      #   description: Name of the reference dissociated dataset
      #   required: true
      - name: segmentation_id
        type: string
        description: Custom segmentation identifier
        required: false
      # - name: patch
      #   type: string
      #   description: Expert segmentation image patch identifier
      #   required: false
    
    images:
      - type: datatree
        name: "{rep}_image"
        description: The raw image data
        required: true
        coordinates:
          - type: integer
            name: c
            required: true
          - type: double
            name: "y"
            required: true
          - type: double
            name: x
            required: true
      - type: datatree
        name: "{rep}_image_3D"
        description: The raw 3D image data
        required: false
        coordinates: [] # TODO
      - type: datatree
        name: "{rep}_he_image"
        description: H&E image data
        required: false 
        coordinates: [] # TODO
    labels:
      - type: datatree
        dtype: int
        name: "{rep}_{segm}"
        description: Custom segmentation of the data
        required: false
      - type: datatree
        dtype: int
        name: "{rep}_{segm}_3D"
        description: Custom segmentation of the 3D data
        required: false
      # - type: datatree
      #   dtype: int
      #   name: "{rep}_expert_segm_{patch}"
      #   description: Expert segmentation of a patch of the data
      #   required: false
      # - type: DataTree[zyx]
      #   dtype: int
      #   name: "{rep}_expert_segm_{patch}_3D"
      #   description: Expert segmentation of a 3D patch of the data
      #   required: false
    points:
      - type: dataframe
        name: "{rep}_transcripts"
        description: Point cloud data of transcripts
        required: true
        columns:
          - type: float
            name: "x"
            required: true
          - type: float
            name: "y"
            required: true
          - type: float
            name: "z"
            required: true
          - type: categorical
            name: feature_name
            required: true
          - type: integer
            name: "cell_id"
            required: true
          - type: float
            name: qv
            required: true
          - type: long
            name: transcript_id
            required: true
          - type: boolean
            name: overlaps_nucleus
            required: true

    shapes:
      - type: dataframe
        name: "{rep}_{segm}_boundaries"
        description: Cell polygons referring to "{rep}_{segm}"
        required: false
        columns:
          - type: object
            name: "geometry"
            required: true
    tables:
      - type: anndata
        name: "metadata"
        description: Metadata of spatial dataset
        required: true
        uns:
          - type: string
            name: dataset_id
            required: true
          - type: string
            name: dataset_name
            required: true
          - type: string
            name: dataset_url
            required: true
          - type: string
            name: dataset_reference
            required: true
          - type: string
            name: dataset_summary
            required: true
          - type: string
            name: dataset_description
            required: true
          - type: string
            name: dataset_organism
            required: true
          - type: dictionary
            name: variables
            required: true
            contents:
              - type: string
                name: replicate_id
                required: true
                multiple: true
              - type: string
                name: segmentation_id
                required: true
                multiple: true
      # - type: anndata
      #   dtype: ???
      #   name: "{reference}"
      #   description: Map to define the reference cells to compare to for each rep
      #   required: true
      - type: anndata
        name: "{rep}_{segm}_table"
        description: Count data referring to "{rep}_{segm}"
        required: false
        obs:
          - type: string
            name: cell_id
            required: true
        var:
          - type: string
            name: gene_ids
            required: true
          - type: string
            name: feature_types
            required: true
        obsm:
          - type: float
            name: spatial
            required: true
    coordinate_systems:
      - type: string
        name: "{rep}_global"
        description: Coordinate system of the replicate
        required: true
